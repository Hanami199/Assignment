#!/bin/sh  
#SBATCH --nodes=1
#SBATCH --cpus-per-task=32
#SBATCH --ntasks-per-node=1
#SBATCH --mem=0
#SBATCH --partition dcgp_usr_prod
#SBATCH -A uTS25_Tornator_0
#SBATCH -t 00:15:00
#SBATCH --job-name=test
##SBATCH --exclusive
# =======================================================

module load openmpi/4.1.6--gcc--12.2.0


#export OMP_NUM_THREADS=
export OMP_PLACES=cores
export OMP_PROC_BIND=close
export OMP_DISPLAY_AFFINITY=true

mpicc -march=native -O3 -std=c17 -fopenmp -Iinclude src/stencil_template_parallel.c -o stencil_parallel
mkdir -p outputs_leonardo
RESULTS="outputs_leonardo/results_${SLURM_JOB_ID}.csv"
echo "timestamp,threads,elapsed_s,maxrss_kb" > "$RESULTS"

for nt in 1 2 4 8 16 32; do
  export OMP_NUM_THREADS=$nt
  echo "Running with $nt threads"
  ts=$(date +"%Y%m%d_%H%M%S")
  log="outputs_leonardo/output_${ts}_1Task_${nt}Threads.log"
  # time the step and append to CSV:
  /usr/bin/time -f "%e,%M" -o /tmp/time.$$ \
    srun --ntasks=1 --cpus-per-task=$nt --cpu-bind=cores ./stencil_parallel -e 300 -o 0 -v 1 > "$log"
  read elapsed_kb < /tmp/time.$$
  elapsed=${elapsed_kb%%,*}
  maxrss=${elapsed_kb##*,}
  echo "$ts,$nt,$elapsed,$maxrss" >> "$RESULTS"
  rm -f /tmp/time.$$
done

echo "Done. Logs in outputs_leonardo/, summary in $RESULTS"
